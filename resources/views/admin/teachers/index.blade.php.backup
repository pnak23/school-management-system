@extends('layouts.app')

@section('title', 'Teacher Management')

@section('content')
<div class="max-w-full mx-auto">
    <!-- Page Header -->
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Teacher Management</h1>
            <p class="text-gray-600 mt-1">Manage teacher records and information</p>
        </div>
        @if(auth()->user()->hasAnyRole(['admin', 'manager', 'staff']))
        <button onclick="openCreateModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add Teacher
        </button>
        @endif
    </div>

    <!-- Alert Messages -->
    <div id="alert-container" class="mb-4"></div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Search -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input type="text" id="search-input" placeholder="Search by name or code..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>

            <!-- Status Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="status-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="active">Active Only</option>
                    <option value="all" selected>All Teachers</option>
                    <option value="inactive">Inactive Only</option>
                </select>
            </div>

            <!-- Per Page -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Records per page</label>
                <select id="per-page-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="10">10</option>
                    <option value="15" selected>15</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Teachers Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Photo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khmer Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">English Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="teachers-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Data loaded via Ajax -->
                    <tr>
                        <td colspan="9" class="px-6 py-4 text-center text-gray-500">
                            <div class="flex justify-center items-center">
                                <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span class="ml-2">Loading teachers...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div id="pagination-container" class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
            <div id="pagination-info" class="text-sm text-gray-700">
                <!-- Pagination info will be inserted here -->
            </div>
            <div id="pagination-buttons" class="flex gap-2">
                <!-- Pagination buttons will be inserted here -->
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Teacher Modal -->
<div id="teacher-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-lg bg-white mb-10">
        <!-- Modal Header -->
        <div class="flex justify-between items-center pb-3 border-b">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-900">Add Teacher</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <form id="teacher-form" enctype="multipart/form-data" class="mt-4">
            <input type="hidden" id="teacher-id" name="teacher_id">
            
            <!-- Error Display -->
            <div id="form-errors" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                <ul id="error-list" class="list-disc list-inside text-red-600 text-sm"></ul>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Khmer Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Khmer Name <span class="text-red-500">*</span></label>
                    <input type="text" id="khmer_name" name="khmer_name" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <!-- English Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">English Name</label>
                    <input type="text" id="english_name" name="english_name"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <!-- Date of Birth -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                    <input type="date" id="dob" name="dob"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <!-- Sex -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sex <span class="text-red-500">*</span></label>
                    <select id="sex" name="sex" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">Select Sex</option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                    </select>
                </div>

                <!-- Teacher Code -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Teacher Code</label>
                    <input type="text" id="teacher_code" name="teacher_code"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <!-- Phone -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number <span class="text-red-500">*</span></label>
                    <div class="flex gap-2">
                        <input type="text" id="phone" name="phone" required
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <button type="button" id="manage-phones-btn" onclick="openManagePhonesModal()" 
                            class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition whitespace-nowrap">
                            + Add Phone
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Primary phone (required). Click "+ Add Phone" after saving to add more.</p>
                </div>

                <!-- Department -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                    <select id="department_id" name="department_id"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">Select Department</option>
                        @foreach($departments as $dept)
                            <option value="{{ $dept->id }}">{{ $dept->name }}</option>
                        @endforeach
                    </select>
                </div>

                <!-- Position -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
                    <select id="position_id" name="position_id"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">Select Position</option>
                        @foreach($positions as $pos)
                            <option value="{{ $pos->id }}">{{ $pos->name }}</option>
                        @endforeach
                    </select>
                </div>

                <!-- Employment Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Employment Type</label>
                    <select id="employment_type_id" name="employment_type_id"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">Select Employment Type</option>
                        @foreach($employmentTypes as $type)
                            <option value="{{ $type->id }}">{{ $type->name }}</option>
                        @endforeach
                    </select>
                </div>

                <!-- Linked User -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Linked User</label>
                    <select id="user_id" name="user_id"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">None</option>
                        @foreach(\App\Models\User::orderBy('name')->get(['id','name','email']) as $u)
                            <option value="{{ $u->id }}">{{ $u->name }} ({{ $u->email }})</option>
                        @endforeach
                    </select>
                </div>

                <!-- Phone Note -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Note</label>
                    <input type="text" id="phone_note" name="phone_note"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <!-- Photo -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Photo</label>
                    <input type="file" id="photo" name="photo" accept="image/*"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        onchange="previewPhoto(event)">
                    <div id="photo-preview" class="mt-2 hidden">
                        <img id="preview-image" src="" alt="Preview" class="h-32 w-32 object-cover rounded-lg border">
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="mt-6 flex justify-end gap-3 border-t pt-4">
                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                    Cancel
                </button>
                <button type="submit" id="submit-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    <span id="submit-text">Save Teacher</span>
                    <span id="submit-spinner" class="hidden">
                        <svg class="inline animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Saving...
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- View Teacher Modal -->
<div id="view-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-lg bg-white mb-10">
        <!-- Modal Header -->
        <div class="flex justify-between items-center pb-3 border-b">
            <h3 class="text-2xl font-bold text-gray-900">Teacher Details</h3>
            <button onclick="closeViewModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div id="view-content" class="mt-4">
            <!-- Content will be loaded via Ajax -->
        </div>
    </div>
</div>

<!-- Manage Phones Modal -->
<div id="phones-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-lg bg-white mb-10">
        <!-- Modal Header -->
        <div class="flex justify-between items-center pb-3 border-b">
            <h3 class="text-2xl font-bold text-gray-900">Manage Phone Numbers</h3>
            <button onclick="closePhonesModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="mt-4">
            <input type="hidden" id="phones-teacher-id">
            
            <!-- Add Phone Form -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <h4 class="font-semibold text-gray-900 mb-3">Add New Phone</h4>
                <form id="add-phone-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number <span class="text-red-500">*</span></label>
                        <input type="text" id="new-phone" name="phone" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
                        <input type="text" id="new-phone-note" name="note"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="md:col-span-2 flex items-center">
                        <input type="checkbox" id="new-phone-primary" name="is_primary" class="mr-2">
                        <label for="new-phone-primary" class="text-sm text-gray-700">Set as primary phone</label>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            + Add Phone Number
                        </button>
                    </div>
                </form>
            </div>

            <!-- Phones List -->
            <div>
                <h4 class="font-semibold text-gray-900 mb-3">Existing Phone Numbers</h4>
                <div id="phones-list" class="space-y-2">
                    <!-- Phones will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentEditingId = null;

// Load teachers on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTeachers();
    
    // Event listeners
    document.getElementById('search-input').addEventListener('input', debounce(function() {
        currentPage = 1;
        loadTeachers();
    }, 500));
    
    document.getElementById('status-filter').addEventListener('change', function() {
        currentPage = 1;
        loadTeachers();
    });
    
    document.getElementById('per-page-select').addEventListener('change', function() {
        currentPage = 1;
        loadTeachers();
    });
    
    // Form submit handler
    document.getElementById('teacher-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveTeacher();
    });
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function loadTeachers() {
    const search = document.getElementById('search-input').value;
    const status = document.getElementById('status-filter').value;
    const perPage = document.getElementById('per-page-select').value;
    
    const params = new URLSearchParams({
        page: currentPage,
        per_page: perPage,
        status: status,
        search: search
    });
    
    fetch(`{{ route('admin.teachers.index') }}?${params}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderTeachersTable(data.data);
            renderPagination(data.pagination);
        }
    })
    .catch(error => {
        console.error('Error loading teachers:', error);
        showAlert('Failed to load teachers', 'error');
    });
}

function renderTeachersTable(teachers) {
    const tbody = document.getElementById('teachers-table-body');
    
    if (teachers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">No teachers found</td></tr>';
        return;
    }
    
    tbody.innerHTML = teachers.map(teacher => {
        const photoUrl = teacher.photo ? `/storage/${teacher.photo}` : '/images/default-avatar.png';
        const primaryPhone = teacher.phones && teacher.phones.length > 0 ? teacher.phones.find(p => p.is_primary) || teacher.phones[0] : null;
        const statusBadge = teacher.is_active 
            ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Active</span>'
            : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Inactive</span>';
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                    <img src="${photoUrl}" alt="${teacher.khmer_name}" class="h-10 w-10 rounded-full object-cover">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.teacher_code || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${teacher.khmer_name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.english_name || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.department ? teacher.department.name : '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.position ? teacher.position.name : '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${primaryPhone ? primaryPhone.phone : '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex gap-2">
                        <button onclick="viewTeacher(${teacher.id})" class="text-blue-600 hover:text-blue-900" title="View Details">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                        @if(auth()->user()->hasAnyRole(['admin', 'manager', 'staff']))
                        <button onclick="editTeacher(${teacher.id})" class="text-indigo-600 hover:text-indigo-900" title="Edit">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="toggleStatus(${teacher.id})" class="text-yellow-600 hover:text-yellow-900" title="Toggle Status">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                        </button>
                        @endif
                        @if(auth()->user()->hasAnyRole(['admin', 'manager']))
                        <button onclick="deleteTeacher(${teacher.id})" class="text-red-600 hover:text-red-900" title="Deactivate">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                        @endif
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function renderPagination(pagination) {
    const infoDiv = document.getElementById('pagination-info');
    const buttonsDiv = document.getElementById('pagination-buttons');
    
    const start = (pagination.current_page - 1) * pagination.per_page + 1;
    const end = Math.min(pagination.current_page * pagination.per_page, pagination.total);
    
    infoDiv.innerHTML = `Showing ${start} to ${end} of ${pagination.total} teachers`;
    
    let buttonsHtml = '';
    
    if (pagination.current_page > 1) {
        buttonsHtml += `<button onclick="goToPage(${pagination.current_page - 1})" class="px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50">Previous</button>`;
    }
    
    for (let i = 1; i <= pagination.last_page; i++) {
        if (i === 1 || i === pagination.last_page || (i >= pagination.current_page - 2 && i <= pagination.current_page + 2)) {
            const activeClass = i === pagination.current_page ? 'bg-indigo-600 text-white' : 'bg-white hover:bg-gray-50';
            buttonsHtml += `<button onclick="goToPage(${i})" class="px-3 py-1 border border-gray-300 rounded ${activeClass}">${i}</button>`;
        } else if (i === pagination.current_page - 3 || i === pagination.current_page + 3) {
            buttonsHtml += `<span class="px-2">...</span>`;
        }
    }
    
    if (pagination.current_page < pagination.last_page) {
        buttonsHtml += `<button onclick="goToPage(${pagination.current_page + 1})" class="px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50">Next</button>`;
    }
    
    buttonsDiv.innerHTML = buttonsHtml;
}

function goToPage(page) {
    currentPage = page;
    loadTeachers();
}

function openCreateModal() {
    currentEditingId = null;
    document.getElementById('modal-title').textContent = 'Add Teacher';
    document.getElementById('teacher-form').reset();
    document.getElementById('teacher-id').value = '';
    document.getElementById('photo-preview').classList.add('hidden');
    document.getElementById('form-errors').classList.add('hidden');
    document.getElementById('manage-phones-btn').classList.add('hidden');
    document.getElementById('teacher-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('teacher-modal').classList.add('hidden');
    currentEditingId = null;
}

function editTeacher(id) {
    currentEditingId = id;
    document.getElementById('modal-title').textContent = 'Edit Teacher';
    
    fetch(`{{ route('admin.teachers.index') }}/${id}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const teacher = data.data;
            document.getElementById('teacher-id').value = teacher.id;
            document.getElementById('khmer_name').value = teacher.khmer_name;
            document.getElementById('english_name').value = teacher.english_name || '';
            document.getElementById('dob').value = teacher.dob || '';
            document.getElementById('sex').value = teacher.sex;
            document.getElementById('teacher_code').value = teacher.teacher_code || '';
            document.getElementById('department_id').value = teacher.department_id || '';
            document.getElementById('position_id').value = teacher.position_id || '';
            document.getElementById('employment_type_id').value = teacher.employment_type_id || '';
            document.getElementById('user_id').value = teacher.user_id || '';
            
            const primaryPhone = teacher.phones && teacher.phones.length > 0 ? teacher.phones.find(p => p.is_primary) || teacher.phones[0] : null;
            document.getElementById('phone').value = primaryPhone ? primaryPhone.phone : '';
            document.getElementById('phone_note').value = primaryPhone ? (primaryPhone.note || '') : '';
            
            // Show the manage phones button when editing
            document.getElementById('manage-phones-btn').classList.remove('hidden');
            
            if (teacher.photo) {
                document.getElementById('photo-preview').classList.remove('hidden');
                document.getElementById('preview-image').src = `/storage/${teacher.photo}`;
            }
            
            document.getElementById('form-errors').classList.add('hidden');
            document.getElementById('teacher-modal').classList.remove('hidden');
        }
    })
    .catch(error => {
        console.error('Error loading teacher:', error);
        showAlert('Failed to load teacher details', 'error');
    });
}

function saveTeacher() {
    const form = document.getElementById('teacher-form');
    const formData = new FormData(form);
    const id = document.getElementById('teacher-id').value;
    
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitSpinner = document.getElementById('submit-spinner');
    
    submitBtn.disabled = true;
    submitText.classList.add('hidden');
    submitSpinner.classList.remove('hidden');
    
    const url = id ? `{{ route('admin.teachers.index') }}/${id}` : '{{ route('admin.teachers.store') }}';
    const method = id ? 'POST' : 'POST';
    
    if (id) {
        formData.append('_method', 'PUT');
    }
    
    fetch(url, {
        method: method,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            closeModal();
            loadTeachers();
        } else {
            if (data.errors) {
                displayErrors(data.errors);
            } else {
                showAlert(data.message || 'Failed to save teacher', 'error');
            }
        }
    })
    .catch(error => {
        console.error('Error saving teacher:', error);
        showAlert('Failed to save teacher', 'error');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitText.classList.remove('hidden');
        submitSpinner.classList.add('hidden');
    });
}

function deleteTeacher(id) {
    if (!confirm('Are you sure you want to deactivate this teacher?')) {
        return;
    }
    
    fetch(`{{ route('admin.teachers.index') }}/${id}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            loadTeachers();
        } else {
            showAlert(data.message || 'Failed to deactivate teacher', 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting teacher:', error);
        showAlert('Failed to deactivate teacher', 'error');
    });
}

function toggleStatus(id) {
    fetch(`{{ route('admin.teachers.index') }}/${id}/toggle-status`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            loadTeachers();
        } else {
            showAlert(data.message || 'Failed to toggle status', 'error');
        }
    })
    .catch(error => {
        console.error('Error toggling status:', error);
        showAlert('Failed to toggle status', 'error');
    });
}

function previewPhoto(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('photo-preview').classList.remove('hidden');
            document.getElementById('preview-image').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

function displayErrors(errors) {
    const errorList = document.getElementById('error-list');
    const formErrors = document.getElementById('form-errors');
    
    errorList.innerHTML = '';
    
    Object.values(errors).forEach(errorArray => {
        errorArray.forEach(error => {
            const li = document.createElement('li');
            li.textContent = error;
            errorList.appendChild(li);
        });
    });
    
    formErrors.classList.remove('hidden');
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    const bgColor = type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800';
    
    const alert = document.createElement('div');
    alert.className = `p-4 rounded-lg border ${bgColor} mb-4`;
    alert.textContent = message;
    
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// View Teacher Details Modal
function viewTeacher(id) {
    document.getElementById('view-modal').classList.remove('hidden');
    document.getElementById('view-content').innerHTML = '<div class="text-center py-4">Loading...</div>';
    
    fetch(`{{ route('admin.teachers.index') }}/${id}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayTeacherDetails(data.data);
        } else {
            showAlert('Failed to load teacher details', 'error');
            closeViewModal();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to load teacher details', 'error');
        closeViewModal();
    });
}

function displayTeacherDetails(teacher) {
    const photoUrl = teacher.photo ? `/storage/${teacher.photo}` : '/images/default-avatar.png';
    const primaryPhone = teacher.phones && teacher.phones.length > 0 ? teacher.phones.find(p => p.is_primary) || teacher.phones[0] : null;
    
    const html = `
        <div class="space-y-4">
            <div class="flex items-center gap-4 pb-4 border-b">
                <img src="${photoUrl}" alt="${teacher.khmer_name}" class="h-24 w-24 rounded-full object-cover">
                <div>
                    <h4 class="text-xl font-bold text-gray-900">${teacher.khmer_name}</h4>
                    ${teacher.english_name ? `<p class="text-gray-600">${teacher.english_name}</p>` : ''}
                    <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ${teacher.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} mt-2">
                        ${teacher.is_active ? 'Active' : 'Inactive'}
                    </span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-500">Teacher Code</label>
                    <p class="text-gray-900">${teacher.teacher_code || '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Sex</label>
                    <p class="text-gray-900">${teacher.sex === 'M' ? 'Male' : 'Female'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Date of Birth</label>
                    <p class="text-gray-900">${teacher.dob || '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Department</label>
                    <p class="text-gray-900">${teacher.department ? teacher.department.name : '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Position</label>
                    <p class="text-gray-900">${teacher.position ? teacher.position.name : '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Employment Type</label>
                    <p class="text-gray-900">${teacher.employment_type ? teacher.employment_type.name : '-'}</p>
                </div>
                <div class="md:col-span-2">
                    <label class="text-sm font-medium text-gray-500">Primary Phone</label>
                    <p class="text-gray-900">${primaryPhone ? primaryPhone.phone : '-'}</p>
                    ${primaryPhone && primaryPhone.note ? `<p class="text-sm text-gray-500">${primaryPhone.note}</p>` : ''}
                </div>
                ${teacher.phones && teacher.phones.length > 1 ? `
                <div class="md:col-span-2">
                    <label class="text-sm font-medium text-gray-500">Other Phones</label>
                    <ul class="text-gray-900 list-disc list-inside">
                        ${teacher.phones.filter(p => !p.is_primary).map(p => `<li>${p.phone}${p.note ? ` (${p.note})` : ''}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                <div class="md:col-span-2">
                    <label class="text-sm font-medium text-gray-500">Linked User</label>
                    <p class="text-gray-900">${teacher.user ? `${teacher.user.name} (${teacher.user.email})` : '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Created At</label>
                    <p class="text-gray-900">${new Date(teacher.created_at).toLocaleString()}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Updated At</label>
                    <p class="text-gray-900">${new Date(teacher.updated_at).toLocaleString()}</p>
                </div>
            </div>
            
            <div class="flex justify-end gap-2 pt-4 border-t">
                <button onclick="closeViewModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                    Close
                </button>
                @if(auth()->user()->hasAnyRole(['admin', 'manager', 'staff']))
                <button onclick="closeViewModal(); editTeacher(${teacher.id})" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    Edit Teacher
                </button>
                @endif
            </div>
        </div>
    `;
    
    document.getElementById('view-content').innerHTML = html;
}

function closeViewModal() {
    document.getElementById('view-modal').classList.add('hidden');
}

// Phone Management Functions
function openManagePhonesModal() {
    const teacherId = document.getElementById('teacher-id').value;
    if (!teacherId) {
        showAlert('Please save the teacher first before managing phones', 'error');
        return;
    }
    
    document.getElementById('phones-teacher-id').value = teacherId;
    document.getElementById('phones-modal').classList.remove('hidden');
    loadTeacherPhones(teacherId);
}

function closePhonesModal() {
    document.getElementById('phones-modal').classList.add('hidden');
    document.getElementById('add-phone-form').reset();
}

function loadTeacherPhones(teacherId) {
    fetch(`{{ route('admin.teachers.index') }}/${teacherId}/phones`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayPhonesList(data.data);
        } else {
            showAlert('Failed to load phones', 'error');
        }
    })
    .catch(error => {
        console.error('Error loading phones:', error);
        showAlert('Failed to load phones', 'error');
    });
}

function displayPhonesList(phones) {
    const phonesList = document.getElementById('phones-list');
    
    if (phones.length === 0) {
        phonesList.innerHTML = '<p class="text-gray-500 text-center py-4">No phone numbers added yet.</p>';
        return;
    }
    
    phonesList.innerHTML = phones.map(phone => `
        <div class="flex items-center justify-between p-3 bg-white border rounded-lg">
            <div class="flex-1">
                <div class="flex items-center gap-2">
                    <span class="font-medium text-gray-900">${phone.phone}</span>
                    ${phone.is_primary ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-indigo-100 text-indigo-800">Primary</span>' : ''}
                    ${!phone.is_active ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Inactive</span>' : ''}
                </div>
                ${phone.note ? `<p class="text-sm text-gray-500 mt-1">${phone.note}</p>` : ''}
            </div>
            <div class="flex gap-2">
                ${!phone.is_primary ? `
                <button onclick="setPrimaryPhone(${phone.id})" class="text-blue-600 hover:text-blue-900" title="Set as primary">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </button>
                ` : ''}
                <button onclick="editPhone(${phone.id}, '${phone.phone}', '${phone.note || ''}', ${phone.is_primary})" class="text-indigo-600 hover:text-indigo-900" title="Edit">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                </button>
                <button onclick="deletePhone(${phone.id})" class="text-red-600 hover:text-red-900" title="Delete">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
}

// Add Phone Form Handler
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('add-phone-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const teacherId = document.getElementById('phones-teacher-id').value;
        const phone = document.getElementById('new-phone').value;
        const note = document.getElementById('new-phone-note').value;
        const isPrimary = document.getElementById('new-phone-primary').checked;
        
        fetch(`{{ route('admin.teachers.index') }}/${teacherId}/phones`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                phone: phone,
                note: note,
                is_primary: isPrimary ? 1 : 0
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                document.getElementById('add-phone-form').reset();
                loadTeacherPhones(teacherId);
                loadTeachers(); // Refresh the main table
            } else {
                showAlert(data.message || 'Failed to add phone', 'error');
            }
        })
        .catch(error => {
            console.error('Error adding phone:', error);
            showAlert('Failed to add phone', 'error');
        });
    });
});

function setPrimaryPhone(phoneId) {
    const teacherId = document.getElementById('phones-teacher-id').value;
    
    fetch(`{{ route('admin.teachers.index') }}/${teacherId}/phones/${phoneId}/set-primary`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            loadTeacherPhones(teacherId);
            loadTeachers(); // Refresh the main table
        } else {
            showAlert(data.message || 'Failed to set primary phone', 'error');
        }
    })
    .catch(error => {
        console.error('Error setting primary phone:', error);
        showAlert('Failed to set primary phone', 'error');
    });
}

let currentEditingPhoneId = null;

function editPhone(phoneId, phone, note, isPrimary) {
    currentEditingPhoneId = phoneId;
    document.getElementById('new-phone').value = phone;
    document.getElementById('new-phone-note').value = note;
    document.getElementById('new-phone-primary').checked = isPrimary;
    
    const submitBtn = document.querySelector('#add-phone-form button[type="submit"]');
    submitBtn.textContent = 'Update Phone Number';
    submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
    submitBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
    
    const cancelBtn = document.createElement('button');
    cancelBtn.type = 'button';
    cancelBtn.textContent = 'Cancel Edit';
    cancelBtn.className = 'w-full px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition mt-2';
    cancelBtn.onclick = cancelPhoneEdit;
    submitBtn.parentElement.appendChild(cancelBtn);
    
    document.getElementById('add-phone-form').onsubmit = function(e) {
        e.preventDefault();
        updatePhone();
    };
}

function cancelPhoneEdit() {
    currentEditingPhoneId = null;
    document.getElementById('add-phone-form').reset();
    
    const submitBtn = document.querySelector('#add-phone-form button[type="submit"]');
    submitBtn.textContent = '+ Add Phone Number';
    submitBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
    submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
    
    const cancelBtn = submitBtn.parentElement.querySelector('button[type="button"]');
    if (cancelBtn) cancelBtn.remove();
    
    document.getElementById('add-phone-form').onsubmit = function(e) {
        e.preventDefault();
        const teacherId = document.getElementById('phones-teacher-id').value;
        const phone = document.getElementById('new-phone').value;
        const note = document.getElementById('new-phone-note').value;
        const isPrimary = document.getElementById('new-phone-primary').checked;
        
        fetch(`{{ route('admin.teachers.index') }}/${teacherId}/phones`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                phone: phone,
                note: note,
                is_primary: isPrimary ? 1 : 0
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                document.getElementById('add-phone-form').reset();
                loadTeacherPhones(teacherId);
                loadTeachers();
            } else {
                showAlert(data.message || 'Failed to add phone', 'error');
            }
        })
        .catch(error => {
            console.error('Error adding phone:', error);
            showAlert('Failed to add phone', 'error');
        });
    };
}

function updatePhone() {
    const teacherId = document.getElementById('phones-teacher-id').value;
    const phone = document.getElementById('new-phone').value;
    const note = document.getElementById('new-phone-note').value;
    const isPrimary = document.getElementById('new-phone-primary').checked;
    
    fetch(`{{ route('admin.teachers.index') }}/${teacherId}/phones/${currentEditingPhoneId}`, {
        method: 'PUT',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
            phone: phone,
            note: note,
            is_primary: isPrimary ? 1 : 0
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            cancelPhoneEdit();
            loadTeacherPhones(teacherId);
            loadTeachers();
        } else {
            showAlert(data.message || 'Failed to update phone', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating phone:', error);
        showAlert('Failed to update phone', 'error');
    });
}

function deletePhone(phoneId) {
    if (!confirm('Are you sure you want to delete this phone number?')) {
        return;
    }
    
    const teacherId = document.getElementById('phones-teacher-id').value;
    
    fetch(`{{ route('admin.teachers.index') }}/${teacherId}/phones/${phoneId}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            loadTeacherPhones(teacherId);
            loadTeachers(); // Refresh the main table
        } else {
            showAlert(data.message || 'Failed to delete phone', 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting phone:', error);
        showAlert('Failed to delete phone', 'error');
    });
}
</script>
@endsection


@section('title', 'Teacher Management')

@section('content')
<div class="max-w-full mx-auto">
    <!-- Page Header -->
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Teacher Management</h1>
            <p class="text-gray-600 mt-1">Manage teacher records and information</p>
        </div>
        @if(auth()->user()->hasAnyRole(['admin', 'manager', 'staff']))
        <button onclick="openCreateModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add Teacher
        </button>
        @endif
    </div>

    <!-- Alert Messages -->
    <div id="alert-container" class="mb-4"></div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Search -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input type="text" id="search-input" placeholder="Search by name or code..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>

            <!-- Status Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="status-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="active">Active Only</option>
                    <option value="all" selected>All Teachers</option>
                    <option value="inactive">Inactive Only</option>
                </select>
            </div>

            <!-- Per Page -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Records per page</label>
                <select id="per-page-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="10">10</option>
                    <option value="15" selected>15</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Teachers Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Photo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khmer Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">English Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="teachers-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Data loaded via Ajax -->
                    <tr>
                        <td colspan="9" class="px-6 py-4 text-center text-gray-500">
                            <div class="flex justify-center items-center">
                                <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span class="ml-2">Loading teachers...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div id="pagination-container" class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
            <div id="pagination-info" class="text-sm text-gray-700">
                <!-- Pagination info will be inserted here -->
            </div>
            <div id="pagination-buttons" class="flex gap-2">
                <!-- Pagination buttons will be inserted here -->
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Teacher Modal -->
<div id="teacher-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-lg bg-white mb-10">
        <!-- Modal Header -->
        <div class="flex justify-between items-center pb-3 border-b">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-900">Add Teacher</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <form id="teacher-form" enctype="multipart/form-data" class="mt-4">
            <input type="hidden" id="teacher-id" name="teacher_id">
            
            <!-- Error Display -->
            <div id="form-errors" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                <ul id="error-list" class="list-disc list-inside text-red-600 text-sm"></ul>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Khmer Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Khmer Name <span class="text-red-500">*</span></label>
                    <input type="text" id="khmer_name" name="khmer_name" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <!-- English Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">English Name</label>
                    <input type="text" id="english_name" name="english_name"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <!-- Date of Birth -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                    <input type="date" id="dob" name="dob"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <!-- Sex -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sex <span class="text-red-500">*</span></label>
                    <select id="sex" name="sex" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">Select Sex</option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                    </select>
                </div>

                <!-- Teacher Code -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Teacher Code</label>
                    <input type="text" id="teacher_code" name="teacher_code"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <!-- Phone -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number <span class="text-red-500">*</span></label>
                    <div class="flex gap-2">
                        <input type="text" id="phone" name="phone" required
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <button type="button" id="manage-phones-btn" onclick="openManagePhonesModal()" 
                            class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition whitespace-nowrap">
                            + Add Phone
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Primary phone (required). Click "+ Add Phone" after saving to add more.</p>
                </div>

                <!-- Department -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                    <select id="department_id" name="department_id"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">Select Department</option>
                        @foreach($departments as $dept)
                            <option value="{{ $dept->id }}">{{ $dept->name }}</option>
                        @endforeach
                    </select>
                </div>

                <!-- Position -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
                    <select id="position_id" name="position_id"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">Select Position</option>
                        @foreach($positions as $pos)
                            <option value="{{ $pos->id }}">{{ $pos->name }}</option>
                        @endforeach
                    </select>
                </div>

                <!-- Employment Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Employment Type</label>
                    <select id="employment_type_id" name="employment_type_id"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">Select Employment Type</option>
                        @foreach($employmentTypes as $type)
                            <option value="{{ $type->id }}">{{ $type->name }}</option>
                        @endforeach
                    </select>
                </div>

                <!-- Linked User -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Linked User</label>
                    <select id="user_id" name="user_id"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">None</option>
                        @foreach(\App\Models\User::orderBy('name')->get(['id','name','email']) as $u)
                            <option value="{{ $u->id }}">{{ $u->name }} ({{ $u->email }})</option>
                        @endforeach
                    </select>
                </div>

                <!-- Phone Note -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Note</label>
                    <input type="text" id="phone_note" name="phone_note"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <!-- Photo -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Photo</label>
                    <input type="file" id="photo" name="photo" accept="image/*"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        onchange="previewPhoto(event)">
                    <div id="photo-preview" class="mt-2 hidden">
                        <img id="preview-image" src="" alt="Preview" class="h-32 w-32 object-cover rounded-lg border">
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="mt-6 flex justify-end gap-3 border-t pt-4">
                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                    Cancel
                </button>
                <button type="submit" id="submit-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    <span id="submit-text">Save Teacher</span>
                    <span id="submit-spinner" class="hidden">
                        <svg class="inline animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Saving...
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- View Teacher Modal -->
<div id="view-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-lg bg-white mb-10">
        <!-- Modal Header -->
        <div class="flex justify-between items-center pb-3 border-b">
            <h3 class="text-2xl font-bold text-gray-900">Teacher Details</h3>
            <button onclick="closeViewModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div id="view-content" class="mt-4">
            <!-- Content will be loaded via Ajax -->
        </div>
    </div>
</div>

<!-- Manage Phones Modal -->
<div id="phones-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-lg bg-white mb-10">
        <!-- Modal Header -->
        <div class="flex justify-between items-center pb-3 border-b">
            <h3 class="text-2xl font-bold text-gray-900">Manage Phone Numbers</h3>
            <button onclick="closePhonesModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="mt-4">
            <input type="hidden" id="phones-teacher-id">
            
            <!-- Add Phone Form -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <h4 class="font-semibold text-gray-900 mb-3">Add New Phone</h4>
                <form id="add-phone-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number <span class="text-red-500">*</span></label>
                        <input type="text" id="new-phone" name="phone" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
                        <input type="text" id="new-phone-note" name="note"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="md:col-span-2 flex items-center">
                        <input type="checkbox" id="new-phone-primary" name="is_primary" class="mr-2">
                        <label for="new-phone-primary" class="text-sm text-gray-700">Set as primary phone</label>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            + Add Phone Number
                        </button>
                    </div>
                </form>
            </div>

            <!-- Phones List -->
            <div>
                <h4 class="font-semibold text-gray-900 mb-3">Existing Phone Numbers</h4>
                <div id="phones-list" class="space-y-2">
                    <!-- Phones will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentEditingId = null;

// Load teachers on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTeachers();
    
    // Event listeners
    document.getElementById('search-input').addEventListener('input', debounce(function() {
        currentPage = 1;
        loadTeachers();
    }, 500));
    
    document.getElementById('status-filter').addEventListener('change', function() {
        currentPage = 1;
        loadTeachers();
    });
    
    document.getElementById('per-page-select').addEventListener('change', function() {
        currentPage = 1;
        loadTeachers();
    });
    
    // Form submit handler
    document.getElementById('teacher-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveTeacher();
    });
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function loadTeachers() {
    const search = document.getElementById('search-input').value;
    const status = document.getElementById('status-filter').value;
    const perPage = document.getElementById('per-page-select').value;
    
    const params = new URLSearchParams({
        page: currentPage,
        per_page: perPage,
        status: status,
        search: search
    });
    
    fetch(`{{ route('admin.teachers.index') }}?${params}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderTeachersTable(data.data);
            renderPagination(data.pagination);
        }
    })
    .catch(error => {
        console.error('Error loading teachers:', error);
        showAlert('Failed to load teachers', 'error');
    });
}

function renderTeachersTable(teachers) {
    const tbody = document.getElementById('teachers-table-body');
    
    if (teachers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">No teachers found</td></tr>';
        return;
    }
    
    tbody.innerHTML = teachers.map(teacher => {
        const photoUrl = teacher.photo ? `/storage/${teacher.photo}` : '/images/default-avatar.png';
        const primaryPhone = teacher.phones && teacher.phones.length > 0 ? teacher.phones.find(p => p.is_primary) || teacher.phones[0] : null;
        const statusBadge = teacher.is_active 
            ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Active</span>'
            : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Inactive</span>';
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                    <img src="${photoUrl}" alt="${teacher.khmer_name}" class="h-10 w-10 rounded-full object-cover">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.teacher_code || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${teacher.khmer_name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.english_name || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.department ? teacher.department.name : '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.position ? teacher.position.name : '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${primaryPhone ? primaryPhone.phone : '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex gap-2">
                        <button onclick="viewTeacher(${teacher.id})" class="text-blue-600 hover:text-blue-900" title="View Details">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                        @if(auth()->user()->hasAnyRole(['admin', 'manager', 'staff']))
                        <button onclick="editTeacher(${teacher.id})" class="text-indigo-600 hover:text-indigo-900" title="Edit">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="toggleStatus(${teacher.id})" class="text-yellow-600 hover:text-yellow-900" title="Toggle Status">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                        </button>
                        @endif
                        @if(auth()->user()->hasAnyRole(['admin', 'manager']))
                        <button onclick="deleteTeacher(${teacher.id})" class="text-red-600 hover:text-red-900" title="Deactivate">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                        @endif
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function renderPagination(pagination) {
    const infoDiv = document.getElementById('pagination-info');
    const buttonsDiv = document.getElementById('pagination-buttons');
    
    const start = (pagination.current_page - 1) * pagination.per_page + 1;
    const end = Math.min(pagination.current_page * pagination.per_page, pagination.total);
    
    infoDiv.innerHTML = `Showing ${start} to ${end} of ${pagination.total} teachers`;
    
    let buttonsHtml = '';
    
    if (pagination.current_page > 1) {
        buttonsHtml += `<button onclick="goToPage(${pagination.current_page - 1})" class="px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50">Previous</button>`;
    }
    
    for (let i = 1; i <= pagination.last_page; i++) {
        if (i === 1 || i === pagination.last_page || (i >= pagination.current_page - 2 && i <= pagination.current_page + 2)) {
            const activeClass = i === pagination.current_page ? 'bg-indigo-600 text-white' : 'bg-white hover:bg-gray-50';
            buttonsHtml += `<button onclick="goToPage(${i})" class="px-3 py-1 border border-gray-300 rounded ${activeClass}">${i}</button>`;
        } else if (i === pagination.current_page - 3 || i === pagination.current_page + 3) {
            buttonsHtml += `<span class="px-2">...</span>`;
        }
    }
    
    if (pagination.current_page < pagination.last_page) {
        buttonsHtml += `<button onclick="goToPage(${pagination.current_page + 1})" class="px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50">Next</button>`;
    }
    
    buttonsDiv.innerHTML = buttonsHtml;
}

function goToPage(page) {
    currentPage = page;
    loadTeachers();
}

function openCreateModal() {
    currentEditingId = null;
    document.getElementById('modal-title').textContent = 'Add Teacher';
    document.getElementById('teacher-form').reset();
    document.getElementById('teacher-id').value = '';
    document.getElementById('photo-preview').classList.add('hidden');
    document.getElementById('form-errors').classList.add('hidden');
    document.getElementById('manage-phones-btn').classList.add('hidden');
    document.getElementById('teacher-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('teacher-modal').classList.add('hidden');
    currentEditingId = null;
}

function editTeacher(id) {
    currentEditingId = id;
    document.getElementById('modal-title').textContent = 'Edit Teacher';
    
    fetch(`{{ route('admin.teachers.index') }}/${id}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const teacher = data.data;
            document.getElementById('teacher-id').value = teacher.id;
            document.getElementById('khmer_name').value = teacher.khmer_name;
            document.getElementById('english_name').value = teacher.english_name || '';
            document.getElementById('dob').value = teacher.dob || '';
            document.getElementById('sex').value = teacher.sex;
            document.getElementById('teacher_code').value = teacher.teacher_code || '';
            document.getElementById('department_id').value = teacher.department_id || '';
            document.getElementById('position_id').value = teacher.position_id || '';
            document.getElementById('employment_type_id').value = teacher.employment_type_id || '';
            document.getElementById('user_id').value = teacher.user_id || '';
            
            const primaryPhone = teacher.phones && teacher.phones.length > 0 ? teacher.phones.find(p => p.is_primary) || teacher.phones[0] : null;
            document.getElementById('phone').value = primaryPhone ? primaryPhone.phone : '';
            document.getElementById('phone_note').value = primaryPhone ? (primaryPhone.note || '') : '';
            
            // Show the manage phones button when editing
            document.getElementById('manage-phones-btn').classList.remove('hidden');
            
            if (teacher.photo) {
                document.getElementById('photo-preview').classList.remove('hidden');
                document.getElementById('preview-image').src = `/storage/${teacher.photo}`;
            }
            
            document.getElementById('form-errors').classList.add('hidden');
            document.getElementById('teacher-modal').classList.remove('hidden');
        }
    })
    .catch(error => {
        console.error('Error loading teacher:', error);
        showAlert('Failed to load teacher details', 'error');
    });
}

function saveTeacher() {
    const form = document.getElementById('teacher-form');
    const formData = new FormData(form);
    const id = document.getElementById('teacher-id').value;
    
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitSpinner = document.getElementById('submit-spinner');
    
    submitBtn.disabled = true;
    submitText.classList.add('hidden');
    submitSpinner.classList.remove('hidden');
    
    const url = id ? `{{ route('admin.teachers.index') }}/${id}` : '{{ route('admin.teachers.store') }}';
    const method = id ? 'POST' : 'POST';
    
    if (id) {
        formData.append('_method', 'PUT');
    }
    
    fetch(url, {
        method: method,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            closeModal();
            loadTeachers();
        } else {
            if (data.errors) {
                displayErrors(data.errors);
            } else {
                showAlert(data.message || 'Failed to save teacher', 'error');
            }
        }
    })
    .catch(error => {
        console.error('Error saving teacher:', error);
        showAlert('Failed to save teacher', 'error');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitText.classList.remove('hidden');
        submitSpinner.classList.add('hidden');
    });
}

function deleteTeacher(id) {
    if (!confirm('Are you sure you want to deactivate this teacher?')) {
        return;
    }
    
    fetch(`{{ route('admin.teachers.index') }}/${id}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            loadTeachers();
        } else {
            showAlert(data.message || 'Failed to deactivate teacher', 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting teacher:', error);
        showAlert('Failed to deactivate teacher', 'error');
    });
}

function toggleStatus(id) {
    fetch(`{{ route('admin.teachers.index') }}/${id}/toggle-status`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            loadTeachers();
        } else {
            showAlert(data.message || 'Failed to toggle status', 'error');
        }
    })
    .catch(error => {
        console.error('Error toggling status:', error);
        showAlert('Failed to toggle status', 'error');
    });
}

function previewPhoto(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('photo-preview').classList.remove('hidden');
            document.getElementById('preview-image').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

function displayErrors(errors) {
    const errorList = document.getElementById('error-list');
    const formErrors = document.getElementById('form-errors');
    
    errorList.innerHTML = '';
    
    Object.values(errors).forEach(errorArray => {
        errorArray.forEach(error => {
            const li = document.createElement('li');
            li.textContent = error;
            errorList.appendChild(li);
        });
    });
    
    formErrors.classList.remove('hidden');
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    const bgColor = type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800';
    
    const alert = document.createElement('div');
    alert.className = `p-4 rounded-lg border ${bgColor} mb-4`;
    alert.textContent = message;
    
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// View Teacher Details Modal
function viewTeacher(id) {
    document.getElementById('view-modal').classList.remove('hidden');
    document.getElementById('view-content').innerHTML = '<div class="text-center py-4">Loading...</div>';
    
    fetch(`{{ route('admin.teachers.index') }}/${id}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayTeacherDetails(data.data);
        } else {
            showAlert('Failed to load teacher details', 'error');
            closeViewModal();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to load teacher details', 'error');
        closeViewModal();
    });
}

function displayTeacherDetails(teacher) {
    const photoUrl = teacher.photo ? `/storage/${teacher.photo}` : '/images/default-avatar.png';
    const primaryPhone = teacher.phones && teacher.phones.length > 0 ? teacher.phones.find(p => p.is_primary) || teacher.phones[0] : null;
    
    const html = `
        <div class="space-y-4">
            <div class="flex items-center gap-4 pb-4 border-b">
                <img src="${photoUrl}" alt="${teacher.khmer_name}" class="h-24 w-24 rounded-full object-cover">
                <div>
                    <h4 class="text-xl font-bold text-gray-900">${teacher.khmer_name}</h4>
                    ${teacher.english_name ? `<p class="text-gray-600">${teacher.english_name}</p>` : ''}
                    <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ${teacher.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} mt-2">
                        ${teacher.is_active ? 'Active' : 'Inactive'}
                    </span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-500">Teacher Code</label>
                    <p class="text-gray-900">${teacher.teacher_code || '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Sex</label>
                    <p class="text-gray-900">${teacher.sex === 'M' ? 'Male' : 'Female'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Date of Birth</label>
                    <p class="text-gray-900">${teacher.dob || '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Department</label>
                    <p class="text-gray-900">${teacher.department ? teacher.department.name : '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Position</label>
                    <p class="text-gray-900">${teacher.position ? teacher.position.name : '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Employment Type</label>
                    <p class="text-gray-900">${teacher.employment_type ? teacher.employment_type.name : '-'}</p>
                </div>
                <div class="md:col-span-2">
                    <label class="text-sm font-medium text-gray-500">Primary Phone</label>
                    <p class="text-gray-900">${primaryPhone ? primaryPhone.phone : '-'}</p>
                    ${primaryPhone && primaryPhone.note ? `<p class="text-sm text-gray-500">${primaryPhone.note}</p>` : ''}
                </div>
                ${teacher.phones && teacher.phones.length > 1 ? `
                <div class="md:col-span-2">
                    <label class="text-sm font-medium text-gray-500">Other Phones</label>
                    <ul class="text-gray-900 list-disc list-inside">
                        ${teacher.phones.filter(p => !p.is_primary).map(p => `<li>${p.phone}${p.note ? ` (${p.note})` : ''}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                <div class="md:col-span-2">
                    <label class="text-sm font-medium text-gray-500">Linked User</label>
                    <p class="text-gray-900">${teacher.user ? `${teacher.user.name} (${teacher.user.email})` : '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Created At</label>
                    <p class="text-gray-900">${new Date(teacher.created_at).toLocaleString()}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Updated At</label>
                    <p class="text-gray-900">${new Date(teacher.updated_at).toLocaleString()}</p>
                </div>
            </div>
            
            <div class="flex justify-end gap-2 pt-4 border-t">
                <button onclick="closeViewModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                    Close
                </button>
                @if(auth()->user()->hasAnyRole(['admin', 'manager', 'staff']))
                <button onclick="closeViewModal(); editTeacher(${teacher.id})" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    Edit Teacher
                </button>
                @endif
            </div>
        </div>
    `;
    
    document.getElementById('view-content').innerHTML = html;
}

function closeViewModal() {
    document.getElementById('view-modal').classList.add('hidden');
}

// Phone Management Functions
function openManagePhonesModal() {
    const teacherId = document.getElementById('teacher-id').value;
    if (!teacherId) {
        showAlert('Please save the teacher first before managing phones', 'error');
        return;
    }
    
    document.getElementById('phones-teacher-id').value = teacherId;
    document.getElementById('phones-modal').classList.remove('hidden');
    loadTeacherPhones(teacherId);
}

function closePhonesModal() {
    document.getElementById('phones-modal').classList.add('hidden');
    document.getElementById('add-phone-form').reset();
}

function loadTeacherPhones(teacherId) {
    fetch(`{{ route('admin.teachers.index') }}/${teacherId}/phones`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayPhonesList(data.data);
        } else {
            showAlert('Failed to load phones', 'error');
        }
    })
    .catch(error => {
        console.error('Error loading phones:', error);
        showAlert('Failed to load phones', 'error');
    });
}

function displayPhonesList(phones) {
    const phonesList = document.getElementById('phones-list');
    
    if (phones.length === 0) {
        phonesList.innerHTML = '<p class="text-gray-500 text-center py-4">No phone numbers added yet.</p>';
        return;
    }
    
    phonesList.innerHTML = phones.map(phone => `
        <div class="flex items-center justify-between p-3 bg-white border rounded-lg">
            <div class="flex-1">
                <div class="flex items-center gap-2">
                    <span class="font-medium text-gray-900">${phone.phone}</span>
                    ${phone.is_primary ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-indigo-100 text-indigo-800">Primary</span>' : ''}
                    ${!phone.is_active ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Inactive</span>' : ''}
                </div>
                ${phone.note ? `<p class="text-sm text-gray-500 mt-1">${phone.note}</p>` : ''}
            </div>
            <div class="flex gap-2">
                ${!phone.is_primary ? `
                <button onclick="setPrimaryPhone(${phone.id})" class="text-blue-600 hover:text-blue-900" title="Set as primary">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </button>
                ` : ''}
                <button onclick="editPhone(${phone.id}, '${phone.phone}', '${phone.note || ''}', ${phone.is_primary})" class="text-indigo-600 hover:text-indigo-900" title="Edit">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                </button>
                <button onclick="deletePhone(${phone.id})" class="text-red-600 hover:text-red-900" title="Delete">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
}

// Add Phone Form Handler
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('add-phone-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const teacherId = document.getElementById('phones-teacher-id').value;
        const phone = document.getElementById('new-phone').value;
        const note = document.getElementById('new-phone-note').value;
        const isPrimary = document.getElementById('new-phone-primary').checked;
        
        fetch(`{{ route('admin.teachers.index') }}/${teacherId}/phones`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                phone: phone,
                note: note,
                is_primary: isPrimary ? 1 : 0
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                document.getElementById('add-phone-form').reset();
                loadTeacherPhones(teacherId);
                loadTeachers(); // Refresh the main table
            } else {
                showAlert(data.message || 'Failed to add phone', 'error');
            }
        })
        .catch(error => {
            console.error('Error adding phone:', error);
            showAlert('Failed to add phone', 'error');
        });
    });
});

function setPrimaryPhone(phoneId) {
    const teacherId = document.getElementById('phones-teacher-id').value;
    
    fetch(`{{ route('admin.teachers.index') }}/${teacherId}/phones/${phoneId}/set-primary`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            loadTeacherPhones(teacherId);
            loadTeachers(); // Refresh the main table
        } else {
            showAlert(data.message || 'Failed to set primary phone', 'error');
        }
    })
    .catch(error => {
        console.error('Error setting primary phone:', error);
        showAlert('Failed to set primary phone', 'error');
    });
}

let currentEditingPhoneId = null;

function editPhone(phoneId, phone, note, isPrimary) {
    currentEditingPhoneId = phoneId;
    document.getElementById('new-phone').value = phone;
    document.getElementById('new-phone-note').value = note;
    document.getElementById('new-phone-primary').checked = isPrimary;
    
    const submitBtn = document.querySelector('#add-phone-form button[type="submit"]');
    submitBtn.textContent = 'Update Phone Number';
    submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
    submitBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
    
    const cancelBtn = document.createElement('button');
    cancelBtn.type = 'button';
    cancelBtn.textContent = 'Cancel Edit';
    cancelBtn.className = 'w-full px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition mt-2';
    cancelBtn.onclick = cancelPhoneEdit;
    submitBtn.parentElement.appendChild(cancelBtn);
    
    document.getElementById('add-phone-form').onsubmit = function(e) {
        e.preventDefault();
        updatePhone();
    };
}

function cancelPhoneEdit() {
    currentEditingPhoneId = null;
    document.getElementById('add-phone-form').reset();
    
    const submitBtn = document.querySelector('#add-phone-form button[type="submit"]');
    submitBtn.textContent = '+ Add Phone Number';
    submitBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
    submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
    
    const cancelBtn = submitBtn.parentElement.querySelector('button[type="button"]');
    if (cancelBtn) cancelBtn.remove();
    
    document.getElementById('add-phone-form').onsubmit = function(e) {
        e.preventDefault();
        const teacherId = document.getElementById('phones-teacher-id').value;
        const phone = document.getElementById('new-phone').value;
        const note = document.getElementById('new-phone-note').value;
        const isPrimary = document.getElementById('new-phone-primary').checked;
        
        fetch(`{{ route('admin.teachers.index') }}/${teacherId}/phones`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                phone: phone,
                note: note,
                is_primary: isPrimary ? 1 : 0
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                document.getElementById('add-phone-form').reset();
                loadTeacherPhones(teacherId);
                loadTeachers();
            } else {
                showAlert(data.message || 'Failed to add phone', 'error');
            }
        })
        .catch(error => {
            console.error('Error adding phone:', error);
            showAlert('Failed to add phone', 'error');
        });
    };
}

function updatePhone() {
    const teacherId = document.getElementById('phones-teacher-id').value;
    const phone = document.getElementById('new-phone').value;
    const note = document.getElementById('new-phone-note').value;
    const isPrimary = document.getElementById('new-phone-primary').checked;
    
    fetch(`{{ route('admin.teachers.index') }}/${teacherId}/phones/${currentEditingPhoneId}`, {
        method: 'PUT',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
            phone: phone,
            note: note,
            is_primary: isPrimary ? 1 : 0
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            cancelPhoneEdit();
            loadTeacherPhones(teacherId);
            loadTeachers();
        } else {
            showAlert(data.message || 'Failed to update phone', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating phone:', error);
        showAlert('Failed to update phone', 'error');
    });
}

function deletePhone(phoneId) {
    if (!confirm('Are you sure you want to delete this phone number?')) {
        return;
    }
    
    const teacherId = document.getElementById('phones-teacher-id').value;
    
    fetch(`{{ route('admin.teachers.index') }}/${teacherId}/phones/${phoneId}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            loadTeacherPhones(teacherId);
            loadTeachers(); // Refresh the main table
        } else {
            showAlert(data.message || 'Failed to delete phone', 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting phone:', error);
        showAlert('Failed to delete phone', 'error');
    });
}
</script>
@endsection

